<!DOCTYPE html>
<html>
<head>
    <title>ì‹¤ì‹œê°„ ì˜ìƒ ìŠ¤íŠ¸ë¦¬ë° ë° ê°ì²´ ë¦¬ìŠ¤íŠ¸</title>
    <script src="https://cdn.socket.io/4.4.1/socket.io.min.js"></script>
    <script>
        const socket = io();

        function readMetadata(filename) {
            console.log("ğŸ“¤ Emit metadata filename:", filename);
            socket.emit("say_metadata", { filename: filename });
        }

        socket.on("spoken_text", (data) => {
            alert("ë¡œë´‡ì´ ë§í•œ ë‚´ìš©: " + data.text);
        });
    </script>
    <script>
        socket.on("keyword_text", function (data) {
            console.log("ğŸ”” ê°ì§€ëœ ëª…ë ¹ ë„ì°©:", data);
            const el = document.getElementById("live-command");
            if (el) {
                el.innerText =
                `Object: ${data.object}, Target: ${data.target}, Command: ${data.commands}`;
            } else {
            console.warn(":x: live-command ìš”ì†Œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŒ");
            }

        });
    </script>

    <style>
        body { font-family: Arial, sans-serif; display: flex; }
        #video-container { margin-right: 20px; }
        #object-list { width: 200px; background: #f0f0f0; padding: 10px; border-radius: 8px; }
        .object-item { padding: 8px; margin-bottom: 6px; background: white; border-radius: 4px; cursor: pointer; }
        .object-item:hover { background: #d0f0ff; }
        .highlight { background: #a0d8ff !important; }
        .dicom-card {
            margin-top: 20px;
            padding: 12px;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 12px;
            box-shadow: 2px 2px 10px #ddd;
            }
            .dicom-card img {
            width: 100%;
            border-radius: 8px;
            margin-bottom: 10px;
            }
            .dicom-meta p {
            margin: 4px 0;
            font-size: 14px;
            color: #444;
            }

    </style>
</head>
<body>
    <div style="display: flex; padding: 20px;">
        <!-- ì™¼ìª½: ì˜ìƒ ìŠ¤íŠ¸ë¦¬ë° -->
        <div id="video-container" style="flex: 1;">
            <h2>ì‹¤ì‹œê°„ ì˜ìƒ ìŠ¤íŠ¸ë¦¬ë°</h2>
            <img id="video-stream" width="800" height="600" />
        </div>

        <!-- ì˜¤ë¥¸ìª½: DICOM ì¹´ë“œ -->
        <div style="width: 400px; margin-left: 30px;">
            {% for image in images %}
            <div class="dicom-card">
                <img src="{{ url_for('serve_image', filename=image.image) }}" alt="dicom preview" />
                <!-- <img src="/static/converted/example.png" alt="dicom preview" /> -->
                <div class="dicom-meta">
                    <h3>{{ image.PatientName }}</h3>
                    <p>ì„±ë³„: {{ image.PatientSex }}</p>
                    <p>ë‚˜ì´: {{ image.PatientAge }}</p>
                    <p>í™˜ì ID: {{ image.PatientID }}</p>
                    <p>ì¢…: {{ image.PatientSpeciesDescription }}</p>
                    <p>í’ˆì¢…: {{ image.PatientBreedDescription }}</p>
                    <p>ê²€ì‚¬ ëª©ì : {{ image.SeriesDescription }}</p>
                    <p>ì´¬ì˜ ë‚ ì§œ: {{ image.StudyDate }}</p>
                    <p>ì´¬ì˜ ì‹œê°„: {{ image.StudyTime }}</p>
                </div>
                <button onclick="readMetadata('{{ image.filename }}')">ğŸ“· í™˜ì ì •ë³´ ì½ê¸°</button>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- ì•„ë˜ìª½: ê°ì²´ ë¦¬ìŠ¤íŠ¸ -->
    <div id="object-list" style="padding: 20px; background: #f0f0f0;">
        <h3>íƒì§€ ê°ì²´ ëª©ë¡</h3>
        <div id="objects" style="display: flex; flex-wrap: wrap; gap: 10px;"></div>
    </div>
        
    <div style="margin-top: 20px;">
        <h3>ğŸ—£ï¸ ì‚¬ìš©ì ëª…ë ¹ì–´ (ì‹¤ì‹œê°„)</h3>
        <p id="live-command" style="font-size: 18px; font-weight: bold; color: #333;"></p>
    </div>

    <style>
    #objectsDiv {
        display: flex;
        flex-direction: column; /* ì„¸ë¡œ ì •ë ¬ */
        gap: 10px; /* í•­ëª© ê°„ ê°„ê²© */
    }

    .object-item {
        border: 1px solid #ccc;
        padding: 10px;
        border-radius: 6px;
        background-color: #f2f2f2;
        cursor: pointer;
    }

    .object-item:hover {
        background-color: #e0e0e0;
    }
    </style>



    <script>
        
        const img = document.getElementById('video-stream');
        const objectsDiv = document.getElementById('objects');
        let selectedObjectId = null;
        let lastClickTime = 0;

        // ì˜ìƒ ìˆ˜ì‹  ì²˜ë¦¬
        socket.on('binary_frame', (data) => {
            try {
                img.src = `data:image/jpeg;base64,${data.image}`;
            } catch (e) {
                console.error('ì´ë¯¸ì§€ ì²˜ë¦¬ ì˜¤ë¥˜:', e);
            }
        });

        // ê°ì²´ ì„ íƒ í•¸ë“¤ëŸ¬ (ê°•í™”ëœ ë²„ì „)
        function handleObjectSelection(obj) {
            if (!obj || !obj.raw_id) return;
            
            const now = Date.now();
            if (now - lastClickTime < 300) return;
            lastClickTime = now;
            
            // ì„ íƒ ìƒíƒœ ì—…ë°ì´íŠ¸
            selectedObjectId = obj.raw_id;
            updateSelectionUI(selectedObjectId);
            
            // ì„œë²„ì— ì„ íƒ ì•Œë¦¼
            socket.emit('pick_object', {
                id: obj.label,
                raw_id: obj.raw_id
            });
            
            console.log(`Selected: ${obj.label} (ID: ${obj.raw_id})`);
        }

        // UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateSelectionUI(raw_id) {
            // ëª¨ë“  í•˜ì´ë¼ì´íŠ¸ ì œê±°
            document.querySelectorAll('.object-item.highlight').forEach(el => {
                el.classList.remove('highlight');
            });
            
            // ìƒˆ ì„ íƒ ì ìš©
            const selectedElement = document.getElementById(`obj-${raw_id}`);
            if (selectedElement) {
                selectedElement.classList.add('highlight');
                selectedElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        // ì„œë²„ë¡œë¶€í„° ì„ íƒ í™•ì¸ ì‘ë‹µ
        socket.on('selection_confirmed', (data) => {
            console.log(`Server confirmed selection: ${data.raw_id}`);
            updateSelectionUI(data.raw_id);
        });

        // ê°ì²´ ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
        socket.on('detection_list', (objList) => {
            objectsDiv.innerHTML = '';
            objList.forEach(obj => {
                const div = document.createElement('div');
                div.className = 'object-item';
                div.id = `obj-${obj.raw_id}`;
                div.innerHTML = `
                    <strong>${obj.label}</strong><br/>
                    Confidence: ${obj.score}%<br/>
                `;
                
                div.addEventListener('click', () => handleObjectSelection(obj));
                objectsDiv.appendChild(div);
            });
            
            // ê¸°ì¡´ ì„ íƒ ìƒíƒœ ë³µì›
            if (selectedObjectId) {
                updateSelectionUI(selectedObjectId);
            }
        });


        socket.on('connect', () => {
            console.log('ì›¹ í´ë¼ì´ì–¸íŠ¸ ì—°ê²°ë¨');
        });
        window.onload = function () {
      fetch("/say_text", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({text: "info/info"})
      })
      .then(res => res.json())
      .then(data => {
        if (data.popup) {
          alert("í™˜ì ì •ë³´ë¥¼ ë³´ì‹œë ¤ë©´ ì‚¬ì§„ì„ í´ë¦­í•´ì£¼ì„¸ìš”!");
          document.querySelectorAll(".metadata-btn").forEach(btn => btn.disabled = false);
        }
      });
    };

    </script>
</body>
</html>